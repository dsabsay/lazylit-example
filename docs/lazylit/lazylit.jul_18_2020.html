
<!DOCTYPE html>

<html>
<head>
    <title>lazylit.go</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../gocco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
                lazylit.go
            </h1>
            <p> <i>
                Viewing notes written by Daniel Sabsay for lazylit.go at revision <a href="https://github.com/dsabsay/lazylit/blob/1f1a39ac4217e834caa42b7a50961802dc593f18/lazylit.go">1f1a39ac4217e834caa42b7a50961802dc593f18 (Jul 18 2020)</a>. Select other revisions via the menu to the right.
            </i> </p>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
          
          <tr id="section-1">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
                
            </td>
            <td class="code">
                <div class="highlight"><pre><span></span></pre></div>
            </td>
          </tr>
          
          <tr id="section-2">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
                <p><strong>lazylit</strong> is a code documentation tool that generates static HTML
that can be published via e.g. GitHub Pages and linked from anywhere
(code comments, READMEs, Jira tickets, etc.).</p>

<p>The code is based on <a href="https://github.com/nikhilm/gocco">gocco</a> which is a
Go port of <a href="http://jashkenas.github.com/docco/">Docco</a>.
It produces HTML that displays your comments
alongside your code. Comments are passed through
<a href="http://daringfireball.net/projects/markdown/syntax">Markdown</a>, and code is
passed through <a href="http://pygments.org/">Pygments</a> syntax highlighting.</p>

<p>The <a href="http://github.com/dsabsay/lazylit">source for lazylit</a> is available on
GitHub, and released under the MIT license.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&quot;bytes&quot;</span>
	<span class="s">&quot;container/list&quot;</span>
	<span class="s">&quot;flag&quot;</span>
	<span class="s">&quot;fmt&quot;</span>
	<span class="s">&quot;github.com/russross/blackfriday&quot;</span>
	<span class="s">&quot;io&quot;</span>
	<span class="s">&quot;io/ioutil&quot;</span>
	<span class="s">&quot;log&quot;</span>
	<span class="s">&quot;os&quot;</span>
	<span class="s">&quot;os/exec&quot;</span>
	<span class="s">&quot;path/filepath&quot;</span>
	<span class="s">&quot;regexp&quot;</span>
	<span class="s">&quot;sort&quot;</span>
	<span class="s">&quot;sync&quot;</span>
	<span class="s">&quot;text/template&quot;</span>
	<span class="s">&quot;time&quot;</span>
<span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-3">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
                <h2>Types</h2>

<p>Due to Go&rsquo;s statically typed nature, what is passed around in object
literals in Docco, requires various structures</p>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-4">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
                <p>A <code>Section</code> captures a piece of documentation and code
Every time interleaving code is found between two comments
a new <code>Section</code> is created.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">type</span> <span class="nx">Section</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">docsText</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">codeText</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">DocsHTML</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">CodeHTML</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-5">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
                <p>a <code>TemplateSection</code> is a section that can be passed
to Go&rsquo;s templating system, which expects strings.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">type</span> <span class="nx">TemplateSection</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">DocsHTML</span> <span class="kt">string</span>
	<span class="nx">CodeHTML</span> <span class="kt">string</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-6">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
                <p>The <code>Index</code> field is used to create anchors to sections</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">Index</span> <span class="kt">int</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-7">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
                <p>a <code>Language</code> describes a programming language</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">type</span> <span class="nx">Language</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">name</span>           <span class="kt">string</span>         <span class="c1">// the `Pygments` name of the language</span>
	<span class="nx">symbol</span>         <span class="kt">string</span>         <span class="c1">// The comment delimiter</span>
	<span class="nx">commentMatcher</span> <span class="o">*</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">Regexp</span> <span class="c1">// The regular expression to match the comment delimiter</span>
	<span class="nx">dividerText</span>    <span class="kt">string</span>         <span class="c1">// Used as a placeholder so we can parse back Pygments output and put the sections together</span>
	<span class="nx">dividerHTML</span>    <span class="o">*</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">Regexp</span> <span class="c1">// The HTML equivalent</span>
	<span class="nx">headerParser</span>   <span class="o">*</span><span class="nx">regexp</span><span class="p">.</span><span class="nx">Regexp</span> <span class="c1">// Extracts header values from comment lines</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-8">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
                <p>a <code>TemplateData</code> is per-file</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">type</span> <span class="nx">TemplateData</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Title</span>          <span class="kt">string</span>             <span class="c1">// Title of the HTML output</span>
	<span class="nx">Sections</span>       <span class="p">[]</span><span class="o">*</span><span class="nx">TemplateSection</span> <span class="c1">// The Sections making up this file</span>
	<span class="nx">OtherRevisions</span> <span class="p">[]</span><span class="nx">ArtifactSnapshot</span> <span class="c1">// List of other revisions for same artifact.</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-9">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
                <p>Only generate the TOC if there is more than one file (<code>Multiple == true</code>).
Go&rsquo;s templating system does not allow expressions in the
template, so calculate it outside</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">Multiple</span> <span class="kt">bool</span>
	<span class="nx">Snapshot</span> <span class="o">*</span><span class="nx">ArtifactSnapshot</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-10">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
                <p>a map of all the languages we know</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">var</span> <span class="nx">languages</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Language</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-11">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
                <h2>Constants</h2>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">const</span> <span class="nx">VERSION</span> <span class="p">=</span> <span class="s">&quot;0.2.1&quot;</span>
<span class="kd">const</span> <span class="nx">DESCRIPTION</span> <span class="p">=</span> <span class="s">`usage: lazylit [-version]</span>

<span class="s">    Generate source code documentation as static web pages.</span>

<span class="s">    Commented source files must reside in the artifacts/ directory, such as:</span>

<span class="s">        artifacts/</span>
<span class="s">            crazy_makefile/</span>
<span class="s">                Makefile.jul_18_20</span>
<span class="s">                Makefile.apr_1_20</span>
<span class="s">            acrobatic_javascript/</span>
<span class="s">                foo.jul_2_20.js</span>
<span class="s">                foo.jan_14_20.js</span>

<span class="s">    Invoke with no arguments to generate HTML in the docs/ directory.</span>

<span class="s">Flags:</span>
<span class="s">`</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-12">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
                <p>Wrap the code in these</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">const</span> <span class="nx">highlightStart</span> <span class="p">=</span> <span class="s">&quot;&lt;div class=\&quot;highlight\&quot;&gt;&lt;pre&gt;&quot;</span>
<span class="kd">const</span> <span class="nx">highlightEnd</span> <span class="p">=</span> <span class="s">&quot;&lt;/pre&gt;&lt;/div&gt;&quot;</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-13">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
                <h2>Command-line flags</h2>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">var</span> <span class="nx">versionFlag</span> <span class="o">*</span><span class="kt">bool</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Bool</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&quot;Print version info.&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">helpFlag</span> <span class="o">*</span><span class="kt">bool</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Bool</span><span class="p">(</span><span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&quot;Print this help message.&quot;</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-14">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
                <h2>Main documentation generation functions</h2>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-15">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
                <p>Generate the documentation for a single source file
by splitting it into sections, highlighting each section
and putting it together.
The WaitGroup is used to signal we are done, so that the main
goroutine waits for all the sub goroutines</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">generateDocumentation</span><span class="p">(</span><span class="nx">a</span> <span class="nx">ArtifactSnapshot</span><span class="p">,</span> <span class="nx">otherRevs</span> <span class="p">[]</span><span class="nx">ArtifactSnapshot</span><span class="p">,</span> <span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">code</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">DocFileName</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">sections</span> <span class="o">:=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">DocFileName</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">FirstNonHeaderLine</span><span class="p">)</span>
	<span class="nx">highlight</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">DocFileName</span><span class="p">,</span> <span class="nx">sections</span><span class="p">)</span>
	<span class="nx">generateHTML</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">otherRevs</span><span class="p">,</span> <span class="nx">sections</span><span class="p">)</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-16">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
                <p>Parse splits code into <code>Section</code>s</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">source</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">code</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">startLine</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">list</span><span class="p">.</span><span class="nx">List</span> <span class="p">{</span>
	<span class="nx">lines</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">))</span>
	<span class="nx">sections</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span>
	<span class="nx">sections</span><span class="p">.</span><span class="nx">Init</span><span class="p">()</span>
	<span class="nx">language</span> <span class="o">:=</span> <span class="nx">getLanguage</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>

	<span class="kd">var</span> <span class="nx">hasCode</span> <span class="kt">bool</span>
	<span class="kd">var</span> <span class="nx">codeText</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">docsText</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-17">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
                <p>save a new section</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">save</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">code</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-18">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
                <p>deep copy the slices since slices always refer to the same storage
by default</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">docsCopy</span><span class="p">,</span> <span class="nx">codeCopy</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">docs</span><span class="p">)),</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span>
		<span class="nb">copy</span><span class="p">(</span><span class="nx">docsCopy</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span>
		<span class="nb">copy</span><span class="p">(</span><span class="nx">codeCopy</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span>
		<span class="nx">sections</span><span class="p">.</span><span class="nx">PushBack</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Section</span><span class="p">{</span><span class="nx">docsCopy</span><span class="p">,</span> <span class="nx">codeCopy</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">})</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">startLine</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lines</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">line</span> <span class="o">:=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-19">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
                <p>if the line is a comment</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">language</span><span class="p">.</span><span class="nx">commentMatcher</span><span class="p">.</span><span class="nx">Match</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-20">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
                <p>but there was previous code</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">hasCode</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-21">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
                <p>we need to save the existing documentation and text
as a section and start a new section since code blocks
have to be delimited before being sent to Pygments</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>				<span class="nx">save</span><span class="p">(</span><span class="nx">docsText</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">(),</span> <span class="nx">codeText</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">())</span>
				<span class="nx">hasCode</span> <span class="p">=</span> <span class="kc">false</span>
				<span class="nx">codeText</span><span class="p">.</span><span class="nx">Reset</span><span class="p">()</span>
				<span class="nx">docsText</span><span class="p">.</span><span class="nx">Reset</span><span class="p">()</span>
			<span class="p">}</span>
			<span class="nx">docsText</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">language</span><span class="p">.</span><span class="nx">commentMatcher</span><span class="p">.</span><span class="nx">ReplaceAll</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span>
			<span class="nx">docsText</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">hasCode</span> <span class="p">=</span> <span class="kc">true</span>
			<span class="nx">codeText</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
			<span class="nx">codeText</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-22">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
                <p>save any remaining parts of the source file</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">save</span><span class="p">(</span><span class="nx">docsText</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">(),</span> <span class="nx">codeText</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">())</span>
	<span class="k">return</span> <span class="nx">sections</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-23">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
                <p><code>highlight</code> pipes the source to Pygments, section by section
delimited by dividerText, then reads back the highlighted output,
searches for the delimiters and extracts the HTML version of the code
and documentation for each <code>Section</code></p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">highlight</span><span class="p">(</span><span class="nx">source</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">sections</span> <span class="o">*</span><span class="nx">list</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">language</span> <span class="o">:=</span> <span class="nx">getLanguage</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
	<span class="nx">pygments</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="s">&quot;pygmentize&quot;</span><span class="p">,</span> <span class="s">&quot;-l&quot;</span><span class="p">,</span> <span class="nx">language</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;html&quot;</span><span class="p">,</span> <span class="s">&quot;-O&quot;</span><span class="p">,</span> <span class="s">&quot;encoding=utf-8&quot;</span><span class="p">)</span>
	<span class="nx">pygmentsInput</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">pygments</span><span class="p">.</span><span class="nx">StdinPipe</span><span class="p">()</span>
	<span class="nx">pygmentsOutput</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">pygments</span><span class="p">.</span><span class="nx">StdoutPipe</span><span class="p">()</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-24">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
                <p>start the process before we start piping data to it
otherwise the pipe may block</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">pygments</span><span class="p">.</span><span class="nx">Start</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">sections</span><span class="p">.</span><span class="nx">Front</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">pygmentsInput</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">.(</span><span class="o">*</span><span class="nx">Section</span><span class="p">).</span><span class="nx">codeText</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">io</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">pygmentsInput</span><span class="p">,</span> <span class="nx">language</span><span class="p">.</span><span class="nx">dividerText</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">pygmentsInput</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

	<span class="nx">buf</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
	<span class="nx">io</span><span class="p">.</span><span class="nx">Copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">pygmentsOutput</span><span class="p">)</span>

	<span class="nx">output</span> <span class="o">:=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">()</span>
	<span class="nx">output</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Replace</span><span class="p">(</span><span class="nx">output</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">highlightStart</span><span class="p">),</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="nx">output</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Replace</span><span class="p">(</span><span class="nx">output</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">highlightEnd</span><span class="p">),</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

	<span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">sections</span><span class="p">.</span><span class="nx">Front</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">index</span> <span class="o">:=</span> <span class="nx">language</span><span class="p">.</span><span class="nx">dividerHTML</span><span class="p">.</span><span class="nx">FindIndex</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">index</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">index</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="nb">len</span><span class="p">(</span><span class="nx">output</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nx">output</span><span class="p">)}</span>
		<span class="p">}</span>

		<span class="nx">fragment</span> <span class="o">:=</span> <span class="nx">output</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nx">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
		<span class="nx">output</span> <span class="p">=</span> <span class="nx">output</span><span class="p">[</span><span class="nx">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">.(</span><span class="o">*</span><span class="nx">Section</span><span class="p">).</span><span class="nx">CodeHTML</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Join</span><span class="p">([][]</span><span class="kt">byte</span><span class="p">{[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">highlightStart</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">highlightEnd</span><span class="p">)},</span> <span class="nx">fragment</span><span class="p">)</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">.(</span><span class="o">*</span><span class="nx">Section</span><span class="p">).</span><span class="nx">DocsHTML</span> <span class="p">=</span> <span class="nx">blackfriday</span><span class="p">.</span><span class="nx">MarkdownCommon</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">.(</span><span class="o">*</span><span class="nx">Section</span><span class="p">).</span><span class="nx">docsText</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-25">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
                <p>render the final HTML</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">generateHTML</span><span class="p">(</span><span class="nx">a</span> <span class="nx">ArtifactSnapshot</span><span class="p">,</span> <span class="nx">otherRevs</span> <span class="p">[]</span><span class="nx">ArtifactSnapshot</span><span class="p">,</span> <span class="nx">sections</span> <span class="o">*</span><span class="nx">list</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-26">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
                <p>convert every <code>Section</code> into corresponding <code>TemplateSection</code></p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">sectionsArray</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">TemplateSection</span><span class="p">,</span> <span class="nx">sections</span><span class="p">.</span><span class="nx">Len</span><span class="p">())</span>
	<span class="k">for</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">sections</span><span class="p">.</span><span class="nx">Front</span><span class="p">(),</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">i</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">(),</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">sec</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">.(</span><span class="o">*</span><span class="nx">Section</span><span class="p">)</span>
		<span class="nx">docsBuf</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewBuffer</span><span class="p">(</span><span class="nx">sec</span><span class="p">.</span><span class="nx">DocsHTML</span><span class="p">)</span>
		<span class="nx">codeBuf</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewBuffer</span><span class="p">(</span><span class="nx">sec</span><span class="p">.</span><span class="nx">CodeHTML</span><span class="p">)</span>
		<span class="nx">sectionsArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">TemplateSection</span><span class="p">{</span><span class="nx">docsBuf</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span> <span class="nx">codeBuf</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-27">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
                <p>run through the Go template</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">html</span> <span class="o">:=</span> <span class="nx">goccoTemplate</span><span class="p">(</span><span class="nx">TemplateData</span><span class="p">{</span>
		<span class="nx">filepath</span><span class="p">.</span><span class="nx">Base</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">SourceFileName</span><span class="p">),</span>
		<span class="nx">sectionsArray</span><span class="p">,</span>
		<span class="nx">otherRevs</span><span class="p">,</span>
		<span class="nb">len</span><span class="p">(</span><span class="nx">otherRevs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="nx">a</span><span class="p">,</span>
	<span class="p">})</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-28">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
                <p>Replace <em>sources</em> with the revisions for this file
html := goccoTemplate(TemplateData{title, sectionsArray, sources, len(sources) &gt; 1})</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;gocco: &quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">DocFileName</span><span class="p">,</span> <span class="s">&quot; -&gt; &quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Destination</span><span class="p">())</span>
	<span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">Destination</span><span class="p">(),</span> <span class="nx">html</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">goccoTemplate</span><span class="p">(</span><span class="nx">data</span> <span class="nx">TemplateData</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-29">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
                <p>this hack is required because <code>ParseFiles</code> doesn&rsquo;t
seem to work properly, always complaining about empty templates</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gocco&quot;</span><span class="p">).</span><span class="nx">Funcs</span><span class="p">(</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-30">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
                <p>introduce the two functions that the template needs</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">template</span><span class="p">.</span><span class="nx">FuncMap</span><span class="p">{</span>
			<span class="s">&quot;base&quot;</span><span class="p">:</span>        <span class="nx">filepath</span><span class="p">.</span><span class="nx">Base</span><span class="p">,</span>
			<span class="s">&quot;destination&quot;</span><span class="p">:</span> <span class="nx">ArtifactSnapshot</span><span class="p">.</span><span class="nx">Destination</span><span class="p">,</span>
		<span class="p">}).</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">HTML</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">buf</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">()</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-31">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
                <p>get a <code>Language</code> given a path</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">getLanguage</span><span class="p">(</span><span class="nx">source</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Language</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">languages</span><span class="p">[</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Ext</span><span class="p">(</span><span class="nx">source</span><span class="p">)]</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-32">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
                <p>make sure <code>docs/</code> exists</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">ensureDirectory</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">os</span><span class="p">.</span><span class="nx">MkdirAll</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="mo">0755</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">setupLanguages</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">languages</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Language</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-33">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
                <p>you can add more languages here.
only the first two fields should change, the rest should
be <code>nil, &quot;&quot;, nil</code></p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">languages</span><span class="p">[</span><span class="s">&quot;.go&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Language</span><span class="p">{</span><span class="s">&quot;go&quot;</span><span class="p">,</span> <span class="s">&quot;//&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">}</span>
	<span class="nx">languages</span><span class="p">[</span><span class="s">&quot;.py&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Language</span><span class="p">{</span><span class="s">&quot;python&quot;</span><span class="p">,</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">setupLanguages</span><span class="p">()</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-34">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
                <p>create the regular expressions based on the language comment symbol</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">lang</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">languages</span> <span class="p">{</span>
		<span class="nx">lang</span><span class="p">.</span><span class="nx">headerParser</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="s">&quot;^\\s*&quot;</span> <span class="o">+</span> <span class="nx">lang</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s">&quot;\\s*(\\w+):\\s*(.*)$&quot;</span><span class="p">)</span>
		<span class="nx">lang</span><span class="p">.</span><span class="nx">commentMatcher</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="s">&quot;^\\s*&quot;</span> <span class="o">+</span> <span class="nx">lang</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s">&quot;\\s?&quot;</span><span class="p">)</span>
		<span class="nx">lang</span><span class="p">.</span><span class="nx">dividerText</span> <span class="p">=</span> <span class="s">&quot;\n&quot;</span> <span class="o">+</span> <span class="nx">lang</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s">&quot;DIVIDER\n&quot;</span>
		<span class="nx">lang</span><span class="p">.</span><span class="nx">dividerHTML</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="s">&quot;\\n*&lt;span class=\&quot;c1?\&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">lang</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s">&quot;DIVIDER&lt;\\/span&gt;\\n*&quot;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-35">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
                <p>An ArtifactSnapshot represents a single file under the <code>artifacts/</code> directory.
It&rsquo;s intended to represent a given source code file <em>at a specific point in time</em>.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">type</span> <span class="nx">ArtifactSnapshot</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ArtifactName</span>       <span class="kt">string</span>
	<span class="nx">Commit</span>             <span class="kt">string</span>
	<span class="nx">CommitDate</span>         <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
	<span class="nx">CommitDateString</span>   <span class="kt">string</span>
	<span class="nx">SourceFileName</span>     <span class="kt">string</span>
	<span class="nx">SourceLink</span>         <span class="kt">string</span>
	<span class="nx">DocFileName</span>        <span class="kt">string</span> <span class="c1">// name of file under artifacts/</span>
	<span class="nx">DocAuthor</span>          <span class="kt">string</span> <span class="c1">// author of documentation</span>
	<span class="nx">Dest</span>               <span class="kt">string</span> <span class="c1">// name of HTML file</span>
	<span class="nx">FirstNonHeaderLine</span> <span class="kt">int</span>    <span class="c1">// line number of first non-header line</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-36">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
                <p>This is how we make <code>ArtifactSnapshot</code>s sortable by CommitDate.
See <a href="https://gobyexample.com/sorting-by-functions">Sorting by Functions</a>.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">type</span> <span class="nx">byCommitDate</span> <span class="p">[]</span><span class="nx">ArtifactSnapshot</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">byCommitDate</span><span class="p">)</span> <span class="nx">Len</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">byCommitDate</span><span class="p">)</span> <span class="nx">Swap</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">s</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">byCommitDate</span><span class="p">)</span> <span class="nx">Less</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">CommitDate</span><span class="p">.</span><span class="nx">Before</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">CommitDate</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">ArtifactSnapshot</span><span class="p">)</span> <span class="nx">Destination</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">baseName</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Base</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">DocFileName</span><span class="p">)</span>
	<span class="nx">ext</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Ext</span><span class="p">(</span><span class="nx">baseName</span><span class="p">)</span>
	<span class="nx">destBase</span> <span class="o">:=</span> <span class="nx">baseName</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">baseName</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="nx">ext</span><span class="p">)]</span>
	<span class="k">return</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="s">&quot;docs&quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ArtifactName</span><span class="p">,</span> <span class="nx">destBase</span><span class="o">+</span><span class="s">&quot;.html&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">IndexTemplateData</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ArtifactName</span> <span class="kt">string</span>
	<span class="nx">Snapshots</span>    <span class="p">[]</span><span class="nx">ArtifactSnapshot</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-37">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
                <p>Each &ldquo;artifact&rdquo; in lazylit is stored in its own subdirectory of
<code>artifacts/</code>. For example, <code>artifacts/crazy_makefile/</code> might store
all versions of documentation a particular project&rsquo;s Makefile.
The reason for this abstraction (instead of an identifier composed of
e.g. the source repository name and filename) is that this allows for
the source filename and location to change over time. Lazylit can
keep track of all such versions under a single &ldquo;artifact&rdquo;.</p>

<p>Each artifact gets an index page which lists all available documented
versions.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">generateIndexes</span><span class="p">(</span><span class="nx">artifacts</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="nx">ArtifactSnapshot</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;artifact_index&quot;</span><span class="p">).</span><span class="nx">Funcs</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">FuncMap</span><span class="p">{</span>
		<span class="s">&quot;base&quot;</span><span class="p">:</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Base</span><span class="p">,</span>
	<span class="p">}).</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">INDEX_HTML</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">snapshots</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">artifacts</span> <span class="p">{</span>
		<span class="nx">ensureDirectory</span><span class="p">(</span><span class="s">&quot;docs/&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">)</span>
		<span class="nx">dest</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="s">&quot;docs/&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s">&quot;/index.html&quot;</span><span class="p">)</span>
		<span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">dest</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
		<span class="p">}</span>
		<span class="nx">err</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">IndexTemplateData</span><span class="p">{</span><span class="nx">name</span><span class="p">,</span> <span class="nx">snapshots</span><span class="p">})</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-38">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
                <p>Generates a general &ldquo;about&rdquo; page for lazylit.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">generateAbout</span><span class="p">(</span><span class="nx">artifacts</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="nx">ArtifactSnapshot</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;about_page&quot;</span><span class="p">).</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">ABOUT_HTML</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">artifactNames</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">artifacts</span><span class="p">))</span>
	<span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">artifacts</span> <span class="p">{</span>
		<span class="nx">artifactNames</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">artifactNames</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">dest</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="s">&quot;docs&quot;</span><span class="p">,</span> <span class="s">&quot;index.html&quot;</span><span class="p">)</span>
	<span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="nx">dest</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">artifactNames</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-39">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
                <p>Each file under <code>artifacts/</code> must have several headers:</p>

<ul>
<li>Commit: SHA of git commit this documentation is written for</li>
<li>CommitDate: Date of commit in format: <code>Jan 2 2006</code></li>
<li>SourceFile: Filename of original source code (as it is named in production codebase)</li>
<li>SourceLink: A URL to the original source code file. Should be static (i.e. contain the commit SHA).</li>
<li>DocAuthor: Name of person writing this documentation.</li>
</ul>

<p>See <a href="https://github.com/dsabsay/lazylit-example/blob/master/artifacts/lazylit/lazylit.jul_18_2020.go#L1">here</a>
for an example of how to define the headers.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">parseHeaders</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">file</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ArtifactSnapshot</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">lines</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">))</span>
	<span class="nx">language</span> <span class="o">:=</span> <span class="nx">getLanguage</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>

	<span class="nx">a</span> <span class="o">:=</span> <span class="nx">ArtifactSnapshot</span><span class="p">{</span><span class="nx">ArtifactName</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">DocFileName</span><span class="p">:</span> <span class="nx">file</span><span class="p">}</span>
	<span class="nx">isMissing</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span>
		<span class="s">&quot;Commit&quot;</span><span class="p">:</span>     <span class="kc">true</span><span class="p">,</span>
		<span class="s">&quot;CommitDate&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="s">&quot;SourceFile&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="s">&quot;SourceLink&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="s">&quot;DocAuthor&quot;</span><span class="p">:</span>  <span class="kc">true</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">line</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lines</span> <span class="p">{</span>
		<span class="nx">matches</span> <span class="o">:=</span> <span class="nx">language</span><span class="p">.</span><span class="nx">headerParser</span><span class="p">.</span><span class="nx">FindStringSubmatch</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span>
		<span class="k">if</span> <span class="nx">matches</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">a</span><span class="p">.</span><span class="nx">FirstNonHeaderLine</span> <span class="p">=</span> <span class="nx">i</span>
			<span class="k">break</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
		<span class="k">case</span> <span class="s">&quot;Commit&quot;</span><span class="p">:</span>
			<span class="nx">a</span><span class="p">.</span><span class="nx">Commit</span> <span class="p">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
			<span class="nx">isMissing</span><span class="p">[</span><span class="s">&quot;Commit&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="k">case</span> <span class="s">&quot;CommitDate&quot;</span><span class="p">:</span>
			<span class="nx">date</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Parse</span><span class="p">(</span><span class="s">&quot;Jan 2 2006&quot;</span><span class="p">,</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Error parsing line: %v&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Unable to parse headers for %v: %v&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">a</span><span class="p">.</span><span class="nx">CommitDate</span> <span class="p">=</span> <span class="nx">date</span>
			<span class="nx">a</span><span class="p">.</span><span class="nx">CommitDateString</span> <span class="p">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
			<span class="nx">isMissing</span><span class="p">[</span><span class="s">&quot;CommitDate&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="k">case</span> <span class="s">&quot;SourceFile&quot;</span><span class="p">:</span>
			<span class="nx">a</span><span class="p">.</span><span class="nx">SourceFileName</span> <span class="p">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
			<span class="nx">isMissing</span><span class="p">[</span><span class="s">&quot;SourceFile&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="k">case</span> <span class="s">&quot;SourceLink&quot;</span><span class="p">:</span>
			<span class="nx">a</span><span class="p">.</span><span class="nx">SourceLink</span> <span class="p">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
			<span class="nx">isMissing</span><span class="p">[</span><span class="s">&quot;SourceLink&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="k">case</span> <span class="s">&quot;DocAuthor&quot;</span><span class="p">:</span>
			<span class="nx">a</span><span class="p">.</span><span class="nx">DocAuthor</span> <span class="p">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
			<span class="nx">isMissing</span><span class="p">[</span><span class="s">&quot;DocAuthor&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-40">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
                <p>check for missing headers</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">missingHeaders</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">missing</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">isMissing</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">missing</span> <span class="p">{</span>
			<span class="nx">missingHeaders</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">missingHeaders</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">missingHeaders</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;%v is missing headers: %v\n&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">missingHeaders</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">a</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-41">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
                <p>let&rsquo;s Go!</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">setup</span><span class="p">()</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nx">Usage</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">flag</span><span class="p">.</span><span class="nx">CommandLine</span><span class="p">.</span><span class="nx">Output</span><span class="p">(),</span> <span class="nx">DESCRIPTION</span><span class="p">)</span>
		<span class="nx">flag</span><span class="p">.</span><span class="nx">PrintDefaults</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>

	<span class="k">if</span> <span class="o">*</span><span class="nx">versionFlag</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;lazylit version %v\n&quot;</span><span class="p">,</span> <span class="nx">VERSION</span><span class="p">)</span>
		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="o">*</span><span class="nx">helpFlag</span> <span class="p">{</span>
		<span class="nx">flag</span><span class="p">.</span><span class="nx">Usage</span><span class="p">()</span>
		<span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">adirs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="s">&quot;artifacts&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nx">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;No artifacts/ directory found.&quot;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-42">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
                <p>Parse the contents of <code>artifacts/</code>, generating a list of
<a href="#section-35"><code>ArtifactSnapshot</code>s</a>.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">pageCount</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="nx">artifacts</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="nx">ArtifactSnapshot</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dir</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">adirs</span> <span class="p">{</span>
		<span class="nx">path</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="s">&quot;artifacts&quot;</span><span class="p">,</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
		<span class="nx">files</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadDir</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">files</span> <span class="p">{</span>
			<span class="nx">fpath</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">Name</span><span class="p">())</span>
			<span class="nx">snap</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">parseHeaders</span><span class="p">(</span><span class="nx">dir</span><span class="p">.</span><span class="nx">Name</span><span class="p">(),</span> <span class="nx">fpath</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
			<span class="p">}</span>
			<span class="nx">artifacts</span><span class="p">[</span><span class="nx">dir</span><span class="p">.</span><span class="nx">Name</span><span class="p">()]</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">artifacts</span><span class="p">[</span><span class="nx">dir</span><span class="p">.</span><span class="nx">Name</span><span class="p">()],</span> <span class="o">*</span><span class="nx">snap</span><span class="p">)</span>
			<span class="nx">pageCount</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="p">}</span>
		<span class="nx">sort</span><span class="p">.</span><span class="nx">Sort</span><span class="p">(</span><span class="nx">sort</span><span class="p">.</span><span class="nx">Reverse</span><span class="p">(</span><span class="nx">byCommitDate</span><span class="p">(</span><span class="nx">artifacts</span><span class="p">[</span><span class="nx">dir</span><span class="p">.</span><span class="nx">Name</span><span class="p">()])))</span>
	<span class="p">}</span>

	<span class="nx">ensureDirectory</span><span class="p">(</span><span class="s">&quot;docs&quot;</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-43">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
                <p>A <code>.nojekyll</code> file ensures GitHub Pages won&rsquo;t run anything through Jekyll.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;docs/.nojekyll&quot;</span><span class="p">)</span>
	<span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">os</span><span class="p">.</span><span class="nx">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Unable to create .nojekyll: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">generateAbout</span><span class="p">(</span><span class="nx">artifacts</span><span class="p">)</span>
	<span class="nx">generateIndexes</span><span class="p">(</span><span class="nx">artifacts</span><span class="p">)</span>
	<span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="s">&quot;docs/gocco.css&quot;</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewBufferString</span><span class="p">(</span><span class="nx">Css</span><span class="p">).</span><span class="nx">Bytes</span><span class="p">(),</span> <span class="mo">0755</span><span class="p">)</span>

	<span class="nx">wg</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">pageCount</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">a</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">artifacts</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">snapshot</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span> <span class="p">{</span>
			<span class="nx">otherRevs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">ArtifactSnapshot</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span>
			<span class="nb">copy</span><span class="p">(</span><span class="nx">otherRevs</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
			<span class="nb">copy</span><span class="p">(</span><span class="nx">otherRevs</span><span class="p">[</span><span class="nx">i</span><span class="p">:],</span> <span class="nx">otherRevs</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
			<span class="nx">otherRevs</span> <span class="p">=</span> <span class="nx">otherRevs</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">otherRevs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">go</span> <span class="nx">generateDocumentation</span><span class="p">(</span><span class="nx">snapshot</span><span class="p">,</span> <span class="nx">otherRevs</span><span class="p">,</span> <span class="nx">wg</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="p">}</span>

</pre></div>
            </td>
          </tr>
          
      </tbody>
    </table>
  </div>
</body>
</html>
